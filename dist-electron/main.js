"use strict";var j=Object.create;var v=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,T=Object.prototype.hasOwnProperty;var W=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of k(t))!T.call(i,a)&&a!==e&&v(i,a,{get:()=>t[a],enumerable:!(s=x(t,a))||s.enumerable});return i};var N=(i,t,e)=>(e=i!=null?j(B(i)):{},W(t||!i||!i.__esModule?v(e,"default",{value:i,enumerable:!0}):e,i));const u=require("electron"),S=require("path"),_=require("fs"),E=require("child_process"),L=require("util"),A=require("fs/promises"),O=L.promisify(E.exec);async function g(i,t){const{stdout:e}=await O(`git ${t}`,{cwd:i,maxBuffer:52428800});return e.trim()}function V(){u.ipcMain.handle("git:getRepositoryInfo",async(i,t)=>{try{const e=await g(t,"rev-parse --abbrev-ref HEAD"),s=await g(t,"rev-list --count HEAD"),a=parseInt(s,10),o=(await g(t,"shortlog -sn HEAD")).split(`
`).filter(h=>h.trim()).length,l=await g(t,"log --reverse --format=%aI | head -1"),f=await g(t,"log -1 --format=%aI");return{name:S.basename(t),path:t,currentBranch:e,totalCommits:a,totalContributors:o,firstCommitDate:new Date(l),lastCommitDate:new Date(f)}}catch(e){throw console.error("Failed to get repository info:",e),e}}),u.ipcMain.handle("git:getCommits",async(i,t,e=10,s=0,a)=>{try{const r="%H|%h|%an|%ae|%aI|%s",o=a||"HEAD",l=e>0?`-n ${e}`:"",f=s>0?`--skip=${s}`:"",h=await g(t,`log ${o} --format="${r}" --shortstat ${l} ${f}`),d=[],n=h.split(`
`);let c=0;for(;c<n.length;){const p=n[c].trim();if(!p){c++;continue}if(p.includes("file changed")||p.includes("files changed")){c++;continue}const m=p.split("|");if(m.length>=6){const $={hash:m[0],shortHash:m[1],author:m[2],authorEmail:m[3],date:new Date(m[4]),message:m[5],filesChanged:0,insertions:0,deletions:0};for(let w=c+1;w<Math.min(c+3,n.length);w++){const y=n[w].trim();if(y&&(y.includes("file changed")||y.includes("files changed"))){const D=y.match(/(\d+) files? changed/),C=y.match(/(\d+) insertions?\s*\(\+\)/),F=y.match(/(\d+) deletions?\s*\(-\)/);D&&($.filesChanged=parseInt(D[1],10)),C&&($.insertions=parseInt(C[1],10)),F&&($.deletions=parseInt(F[1],10));break}}d.push($)}c++}return d}catch(r){throw console.error("Failed to get commits:",r),r}}),u.ipcMain.handle("git:getFileChanges",async(i,t,e)=>{try{const s=await g(t,`diff-tree --no-commit-id --name-status -r ${e}`),a=[],r=s.split(`
`).filter(o=>o.trim());for(const o of r){const[l,...f]=o.split("	"),h=f.join("	");let d="modified",n;l.startsWith("R")?(d="renamed",n=h):l==="A"?d="added":l==="D"?d="deleted":l==="M"&&(d="modified");let c=0,p=0;try{const m=(await g(t,`diff-tree --no-commit-id --numstat -r ${e} -- "${h}"`)).split(`
`)[0];if(m){const[$,w]=m.split("	");c=$==="-"?0:parseInt($,10)||0,p=w==="-"?0:parseInt(w,10)||0}}catch{}a.push({path:h,status:d,insertions:c,deletions:p,previousPath:n})}return a}catch(s){throw console.error("Failed to get file changes:",s),s}}),u.ipcMain.handle("analysis:analyzeRepository",async(i,t)=>{const e=u.BrowserWindow.fromWebContents(i.sender);if(!e)throw new Error("No main window found");const s=(a,r,o,l)=>{e.webContents.send("analysis:progress",{stage:a,current:r,total:o,message:l})};try{s("commits",0,100,"Loading commits...");const r=(await g(t,'log --format="%H|%h|%an|%aI|%s" --all')).split(`
`).filter(n=>n.trim()),o=[],l=[],f=new Map;for(let n=0;n<r.length;n++){const c=r[n].split("|");if(c.length>=5){const p={id:`commit:${c[0]}`,type:"commit",label:c[1],metadata:{hash:c[0],author:c[2],date:new Date(c[3]),message:c[4]}};o.push(p)}n%100===0&&s("commits",n,r.length,`Processing commit ${n}/${r.length}`)}s("files",0,100,"Analyzing file changes...");const h=r.slice(0,Math.min(r.length,200));for(let n=0;n<h.length;n++){const c=h[n].split("|")[0];try{const b=(await g(t,`diff-tree --no-commit-id --name-only -r ${c}`)).split(`
`).filter(m=>m.trim());for(const m of b){const $=`file:${m}`;if(!o.find(w=>w.id===$)){const w=S.extname(m).slice(1),y=G(w);o.push({id:$,type:"file",label:S.basename(m),metadata:{path:m,extension:w,language:y,modifyCount:0}})}f.set($,(f.get($)||0)+1),l.push({id:`edge:${c}-${m}`,source:`commit:${c}`,target:$,type:"MODIFIES"})}}catch{}n%20===0&&s("files",n,h.length,`Analyzing commit ${n}/${h.length}`)}for(const n of o)n.type==="file"&&(n.metadata.modifyCount=f.get(n.id)||0);s("analysis",0,100,"Analyzing code structure...");const d=o.filter(n=>n.type==="file"&&["js","ts","jsx","tsx"].includes(n.metadata.extension));for(let n=0;n<d.length;n++){const c=d[n],p=c.metadata.path,b=S.join(t,p);try{const m=await A.readFile(b,"utf-8"),$=U(m);await Promise.all($.map(async w=>{const y=`function:${p}:${w.name}`;let D=0;try{D=((await g(t,`log -L ${w.startLine},${w.endLine}:"${p}" --format="COMMIT:%H"`)).match(/COMMIT:[a-f0-9]+/g)||[]).length}catch{}o.push({id:y,type:"function",label:w.name,metadata:{name:w.name,filePath:p,startLine:w.startLine,endLine:w.endLine,parameters:w.parameters,modifyCount:D}}),l.push({id:`edge:${c.id}-${y}`,source:c.id,target:y,type:"CONTAINS"})}))}catch{}n%10===0&&s("analysis",n,d.length,`Analyzing ${n}/${d.length} files`)}return s("complete",100,100,"Analysis complete!"),{success:!0,graph:{nodes:o,edges:l},stats:{totalCommits:o.filter(n=>n.type==="commit").length,totalFiles:o.filter(n=>n.type==="file").length,totalFunctions:o.filter(n=>n.type==="function").length,totalRelationships:l.length,analysisTime:0}}}catch(a){return console.error("Analysis failed:",a),{success:!1,graph:{nodes:[],edges:[]},stats:{totalCommits:0,totalFiles:0,totalFunctions:0,totalRelationships:0,analysisTime:0},error:a instanceof Error?a.message:"Unknown error"}}}),u.ipcMain.handle("git:getGitGraph",async(i,t,e=500)=>{try{const a=(await g(t,"branch -a --format='%(refname:short)'")).split(`
`).filter(n=>n.trim()),r=new Map;for(const n of a)try{const p=(await g(t,`rev-parse "${n.replace(/'/g,"")}"`)).trim(),b=n.replace(/'/g,"");r.has(p)||r.set(p,[]),r.get(p).push(b)}catch{}const o="%H|%h|%P|%an|%ae|%aI|%D|%s",l=e>0?`-n ${e}`:"",f=await g(t,`log --all --format="${o}" ${l}`),h=[],d=f.split(`
`).filter(n=>n.trim());for(const n of d){const c=n.split("|");if(c.length>=8){const p=c[0],b=c[2]?c[2].split(" ").filter(y=>y):[];let m=[];const $=c[6];$&&(m=$.split(",").map(y=>y.trim()).map(y=>y.replace(/^HEAD -> /,"")).filter(y=>y&&y!=="HEAD"));const w=r.get(p)||[];for(const y of w)m.includes(y)||m.push(y);h.push({hash:p,shortHash:c[1],author:c[3],authorEmail:c[4],date:new Date(c[5]),message:c[7],parentHashes:b,refs:m})}}return h}catch(s){throw console.error("Failed to get git graph:",s),s}}),u.ipcMain.handle("git:cloneRepository",async(i,t,e)=>new Promise(s=>{var f;const a=((f=t.split("/").pop())==null?void 0:f.replace(".git",""))||"repo",r=S.join(e,a),o=E.spawn("git",["clone","--progress",t,r]);let l="";o.stderr.on("data",h=>{const d=h.toString();l+=d;let n=0,c="cloning";if(d.includes("Counting objects"))c="counting";else if(d.includes("Compressing objects")){c="compressing";const b=d.match(/Compressing objects:\s*(\d+)%/);b&&(n=parseInt(b[1],10))}else if(d.includes("Receiving objects")){c="receiving";const b=d.match(/Receiving objects:\s*(\d+)%/);b&&(n=parseInt(b[1],10))}else if(d.includes("Resolving deltas")){c="resolving";const b=d.match(/Resolving deltas:\s*(\d+)%/);b&&(n=parseInt(b[1],10))}u.BrowserWindow.getAllWindows().forEach(b=>{b.webContents.send("clone-progress",{stage:c,percent:n,message:d.trim()})})}),o.on("close",h=>{s(h===0?{success:!0,path:r}:{success:!1,path:"",error:l||`Clone failed with code ${h}`})}),o.on("error",h=>{s({success:!1,path:"",error:h.message})})})),u.ipcMain.handle("git:getBranches",async(i,t)=>{try{const e=await g(t,"branch -a --format='%(refname:short)|%(HEAD)'"),s=[],a=e.split(`
`).filter(r=>r.trim());for(const r of a){const[o,l]=r.replace(/'/g,"").split("|");if(!o||o.includes("HEAD"))continue;const f=o.startsWith("remotes/")||o.startsWith("origin/"),h=o.replace(/^remotes\//,"");s.find(d=>d.name===h)||s.push({name:h,isCurrent:l==="*",isRemote:f})}return s}catch(e){throw console.error("Failed to get branches:",e),e}}),u.ipcMain.handle("git:getStatus",async(i,t)=>{try{const{stdout:e}=await O("git status --porcelain",{cwd:t,maxBuffer:52428800}),s=[],a=e.split(`
`).filter(r=>r.length>0);console.log("[git:getStatus] Raw output:",JSON.stringify(e)),console.log("[git:getStatus] Parsed lines:",a);for(const r of a){if(r.length<3)continue;const o=r[0],l=r[1],f=r.substring(3).trim();if(console.log(`[git:getStatus] Line: "${r}" | stagedStatus: "${o}" | unstagedStatus: "${l}" | path: "${f}"`),o==="?"&&l==="?"){s.push({path:f,status:"untracked",staged:!1});continue}o!==" "&&o!=="?"&&(console.log(`[git:getStatus] Adding as STAGED: ${f}`),s.push({path:f,status:R(o),staged:!0})),l!==" "&&l!=="?"&&(console.log(`[git:getStatus] Adding as UNSTAGED: ${f}`),s.push({path:f,status:R(l),staged:!1}))}return console.log("[git:getStatus] Final changes:",s),s}catch(e){throw console.error("Failed to get status:",e),e}}),u.ipcMain.handle("git:getAheadBehind",async(i,t)=>{try{const s=(await g(t,"rev-parse --abbrev-ref HEAD")).trim();try{await g(t,`rev-parse --verify origin/${s}`)}catch{return{ahead:0,behind:0}}const r=(await g(t,`rev-list --left-right --count ${s}...origin/${s}`)).trim().split(/\s+/),o=parseInt(r[0]||"0",10),l=parseInt(r[1]||"0",10);return{ahead:o,behind:l}}catch(e){return console.error("Failed to get ahead/behind:",e),{ahead:0,behind:0}}}),u.ipcMain.handle("git:rebase",async(i,t)=>{let e=!1;try{(await g(t,"status --porcelain")).trim().length>0&&(await g(t,'stash push -u -m "Auto stash by RepoInsight"'),e=!0);const r=await g(t,"rev-parse --abbrev-ref HEAD");if(await new Promise((o,l)=>{const f=["pull","--rebase","origin",r.trim()],h=E.spawn("git",f,{cwd:t,stdio:["ignore","pipe","pipe"]});let d="";h.stderr.on("data",n=>{d+=n.toString()}),h.on("close",n=>{n===0?o():l(new Error(d||`git pull --rebase failed with code ${n}`))}),h.on("error",n=>{l(n)})}),e)try{await g(t,"stash pop")}catch(o){return console.warn("Stash pop conflict:",o),{success:!0,message:"Đã rebase thành công, nhưng có xung đột khi khôi phục stash. Vui lòng kiểm tra và giải quyết xung đột.",stashed:!0,conflict:!0}}return{success:!0,message:e?"Đã rebase và khôi phục thay đổi thành công!":"Đã rebase thành công!",stashed:e}}catch(s){if(console.error("Rebase failed:",s),e)try{await g(t,"stash pop")}catch(a){console.error("Failed to pop stash after rebase error:",a)}return{success:!1,message:s.message||"Rebase thất bại. Vui lòng kiểm tra log.",stashed:e}}}),u.ipcMain.handle("git:checkoutBranch",async(i,t,e)=>{try{return await g(t,`checkout ${e}`),{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Failed to switch branch"}}}),u.ipcMain.handle("git:stageFile",async(i,t,e)=>{try{return await g(t,`add "${e}"`),{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Stage failed"}}}),u.ipcMain.handle("git:unstageFile",async(i,t,e)=>{try{return await g(t,`reset HEAD "${e}"`),{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Unstage failed"}}}),u.ipcMain.handle("git:stageAll",async(i,t)=>{try{return await g(t,"add -A"),{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Stage all failed"}}}),u.ipcMain.handle("git:unstageAll",async(i,t)=>{try{return await g(t,"reset HEAD"),{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unstage all failed"}}}),u.ipcMain.handle("git:discardFile",async(i,t,e)=>{try{if((await g(t,`status --porcelain "${e}"`)).startsWith("??")){const a=S.join(t,e);await(await import("fs/promises")).unlink(a)}else await g(t,`checkout -- "${e}"`);return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Discard failed"}}}),u.ipcMain.handle("git:discardAll",async(i,t)=>{try{return await g(t,"checkout -- ."),await g(t,"clean -fd"),{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Discard all failed"}}}),u.ipcMain.handle("git:commit",async(i,t,e)=>{try{const s=e.replace(/"/g,'\\"');return await g(t,`commit -m "${s}"`),{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Commit failed"}}}),u.ipcMain.handle("git:push",async(i,t)=>{try{return await g(t,"push"),{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Push failed"}}}),u.ipcMain.handle("git:getStagedDiff",async(i,t)=>{try{return await g(t,"diff --cached")}catch(e){return console.error("Failed to get staged diff:",e),""}}),u.ipcMain.handle("git:getUnstagedDiff",async(i,t)=>{try{return await g(t,"diff")}catch(e){return console.error("Failed to get unstaged diff:",e),""}}),u.ipcMain.handle("git:getFileDiff",async(i,t,e,s)=>{try{return await g(t,`diff ${s?"--cached":""} -- "${e}"`)}catch(a){return console.error("Failed to get file diff:",a),""}})}function R(i){return{M:"modified",A:"added",D:"deleted",R:"renamed",C:"copied",U:"unmerged","?":"untracked","!":"ignored"}[i]||"unknown"}function G(i){return{js:"JavaScript",jsx:"JavaScript (JSX)",ts:"TypeScript",tsx:"TypeScript (TSX)",vue:"Vue",py:"Python",rb:"Ruby",java:"Java",cpp:"C++",c:"C",go:"Go",rs:"Rust",php:"PHP",swift:"Swift",kt:"Kotlin",cs:"C#",html:"HTML",css:"CSS",scss:"SCSS",less:"LESS",json:"JSON",yaml:"YAML",yml:"YAML",md:"Markdown",sh:"Shell",bash:"Bash"}[i.toLowerCase()]||i.toUpperCase()}function U(i){const t=[],e=i.split(`
`),s=[/^\s*(?:export\s+)?(?:async\s+)?function\s+(\w+)\s*\(([^)]*)\)/,/^\s*(?:export\s+)?(?:const|let|var)\s+(\w+)\s*=\s*(?:async\s+)?\(([^)]*)\)\s*=>/,/^\s*(?:async\s+)?(\w+)\s*\(([^)]*)\)\s*\{/,/^\s*(?:public|private|protected|static|async)?\s*(\w+)\s*\(([^)]*)\)\s*(?::\s*\w+)?\s*\{/];for(let a=0;a<e.length;a++){const r=e[a];for(const o of s){const l=r.match(o);if(l&&l[1]&&!["if","for","while","switch","catch","constructor"].includes(l[1])){const f=l[2]?l[2].split(",").map(c=>c.trim().split(":")[0].trim()).filter(c=>c):[];let h=a,d=0,n=!1;for(let c=a;c<Math.min(a+100,e.length);c++){for(const p of e[c])p==="{"?(d++,n=!0):p==="}"&&d--;if(n&&d===0){h=c;break}}t.push({name:l[1],startLine:a+1,endLine:h+1,parameters:f});break}}}return t}const I=L.promisify(E.exec);function J(){const i=u.app.getPath("userData"),t=S.join(i,"config.json");u.ipcMain.handle("settings:getGitConfig",async(e,s,a)=>{try{const r=a?`git config ${s}`:`git config --global ${s}`,o=a||void 0,{stdout:l}=await I(r,{cwd:o});return l.trim()}catch{return""}}),u.ipcMain.handle("settings:setGitConfig",async(e,s,a,r)=>{try{const o=r?`git config --local ${s} "${a}"`:`git config --global ${s} "${a}"`;return await I(o,{cwd:r||void 0}),!0}catch(o){throw console.error(`Failed to set git config ${s}:`,o),o}}),u.ipcMain.handle("settings:getApiKey",async()=>{try{if(!_.existsSync(t))return"";const e=await A.readFile(t,"utf-8");return JSON.parse(e).geminiApiKey||""}catch(e){return console.error("Failed to read config:",e),""}}),u.ipcMain.handle("settings:setApiKey",async(e,s)=>{try{let a={};if(_.existsSync(t)){const r=await A.readFile(t,"utf-8");try{a=JSON.parse(r)}catch{}}return a.geminiApiKey=s,await A.writeFile(t,JSON.stringify(a,null,2)),!0}catch(a){throw console.error("Failed to save config:",a),a}})}let M=null;function H(){const i=process.env.VITE_DEV_SERVER_URL?S.join(__dirname,"../../public/icon.png"):S.join(__dirname,"../dist/icon.png");M=new u.BrowserWindow({width:1400,height:900,minWidth:1e3,minHeight:700,icon:i,webPreferences:{preload:S.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0},backgroundColor:"#0f172a"}),process.env.VITE_DEV_SERVER_URL?(M.loadURL(process.env.VITE_DEV_SERVER_URL),M.webContents.openDevTools()):M.loadFile(S.join(__dirname,"../dist/index.html")),M.on("closed",()=>{M=null})}u.app.whenReady().then(()=>{V(),J(),H()});u.app.on("window-all-closed",()=>{process.platform!=="darwin"&&u.app.quit()});u.app.on("activate",()=>{u.BrowserWindow.getAllWindows().length===0&&H()});u.ipcMain.handle("dialog:selectRepository",async()=>{const i=await u.dialog.showOpenDialog(M,{properties:["openDirectory"],title:"Select Git Repository"});if(i.canceled||i.filePaths.length===0)return{success:!1,path:null};const t=i.filePaths[0],e=S.join(t,".git"),s=_.existsSync(e);return{success:s,path:t,error:s?null:"Selected folder is not a Git repository (.git folder not found)"}});u.ipcMain.handle("dialog:selectDirectory",async()=>{const i=await u.dialog.showOpenDialog(M,{properties:["openDirectory","createDirectory"],title:"Select Clone Destination"});return i.canceled||i.filePaths.length===0?{success:!1,path:null}:{success:!0,path:i.filePaths[0]}});
